name: Rust

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Install cargo-hack
      run: cargo install cargo-hack
    - name: Build
      run: cargo hack build --manifest-path cold-string/Cargo.toml --verbose --feature-powerset --version-range 1.60.. --exclude-features rkyv
    - name: Check
      run: cargo hack check --manifest-path cold-string/Cargo.toml --verbose --feature-powerset --version-range 1.60.. --exclude-features rkyv
    - name: Test No Exposed Provenance
      run: cargo +1.74 hack test --manifest-path cold-string/Cargo.toml --verbose --feature-powerset --exclude-features rkyv
    - name: Tests
      run: cargo hack test --manifest-path cold-string/Cargo.toml --verbose --feature-powerset
    - name: Install nightly + Miri
      run: |
          rustup toolchain install nightly
          rustup component add miri --toolchain nightly
    - name: Miri 64 bit LE
      run: cargo +nightly miri test --all-features --manifest-path cold-string/Cargo.toml
    - name: Miri 64 bit BE
      run: cargo +nightly miri test --all-features --manifest-path cold-string/Cargo.toml --target powerpc64-unknown-linux-gnu
    - name: Miri 32 bit LE
      run: cargo +nightly miri test --all-features --target i686-unknown-linux-gnu
    - name: Miri 32 bit BE
      run: cargo +nightly miri test --all-features --manifest-path cold-string/Cargo.toml --target mips-unknown-linux-gnu
